# Post-Purchase Delivery Flow

## Overview

When a customer pays $99 for their menu, the following automated delivery flow is triggered:

## Flow Steps

### 1. Stripe Webhook Fires
- Event: `checkout.session.completed`
- Extracts: `slug` and `customer_email` from session metadata
- File: `app/api/webhooks/stripe/route.ts`

### 2. Update Supabase
```sql
UPDATE restaurants SET
  paid = true,
  paid_at = NOW(),
  customer_email = 'customer@example.com'
WHERE slug = 'restaurant-slug';
```

### 3. Generate Deliverables
Files generated automatically:
- ‚úÖ **QR Code** (PNG, 512x512) - Points to `menusready.com/menu/[slug]`
- ‚úÖ **Text Menu** (TXT) - Plain text version for easy pasting
- ‚è≥ **PDF Menu** (TODO) - Formatted PDF with branding
- ‚è≥ **Menu Image** (TODO) - JPG version for Instagram/printing

Generated by: `lib/fileGeneration.ts`

### 4. Customer Email
**Subject:** "Your Menus Ready menu is live üéâ"

**Attachments:**
- QR code PNG
- Text menu file

**Content:**
- Live menu link
- Instructions to print QR code
- Suggestions for display (tables, door, Instagram)

Sent via: `lib/email.ts` ‚Üí Resend API

### 5. Internal Alert Email
**Recipients:** Tim + Remi (hardcoded)

**Subject:** "üí∞ New Menus Ready purchase ‚Äî [Restaurant Name]"

**Content:**
- Restaurant name
- Slug
- Customer email
- Amount ($99)
- Timestamp

**Action items:**
- Verify menu accuracy
- Post to Yelp/Google if needed
- Follow up in 48hrs

### 6. Preview Page Unlocks
When `paid = true`:
- ‚úÖ Removes watermark overlay
- ‚úÖ Removes expiry timer
- ‚úÖ Removes "Publish" CTA
- ‚úÖ Shows green "Your menu is live!" banner
- ‚úÖ Shows all prices clearly
- ‚úÖ No restrictions

## Environment Variables Required

```bash
# Email delivery
RESEND_API_KEY=re_your_resend_api_key

# Supabase (for paid status)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key

# Stripe webhook
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
```

## Supabase Schema

Run migration: `supabase/migrations/003_add_paid_fields.sql`

```sql
alter table restaurants 
  add column paid boolean default false,
  add column paid_at timestamp,
  add column customer_email text;
```

## Testing

### Stripe Test Mode
1. Use Stripe test mode webhook
2. Trigger with test card: `4242 4242 4242 4242`
3. Watch logs: `vercel logs` or check webhook dashboard

### Email Testing
- Without `RESEND_API_KEY`: Logs to console (demo mode)
- With key: Sends real emails

## TODO / Future Enhancements

- [ ] PDF generation (using Puppeteer or react-pdf)
- [ ] JPG image generation (convert PDF first page)
- [ ] Supabase Storage upload for file hosting
- [ ] Customer dashboard to download files again
- [ ] Automated Yelp/Google Business submission API
