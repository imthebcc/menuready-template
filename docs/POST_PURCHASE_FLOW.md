# Post-Purchase Delivery Flow

## Overview

When a customer pays $99, the **preview page transforms into a delivery page** where they can download all files directly. No email attachments needed.

## Flow Steps

### 1. Stripe Webhook Fires
- Event: `checkout.session.completed`
- Extracts: `slug` and `customer_email` from session metadata
- File: `app/api/webhooks/stripe/route.ts`

### 2. Update Supabase
```sql
UPDATE restaurants SET
  paid = true,
  paid_at = NOW(),
  customer_email = 'customer@example.com'
WHERE slug = 'restaurant-slug';
```

### 3. Generate Deliverables
Files generated automatically:
- ‚úÖ **QR Code** (PNG, 512x512) - Points to `menusready.com/menu/[slug]`
- ‚úÖ **Text Menu** (TXT) - Plain text version for easy pasting
- ‚è≥ **PDF Menu** (TODO) - Formatted PDF with branding
- ‚è≥ **Menu Image** (TODO) - JPG version for Instagram/printing

Generated by: `lib/fileGeneration.ts`

### 4. Upload to Supabase Storage
Files uploaded to `menus/{slug}/` bucket:
- `qr-code.png`
- `menu.txt`
- `menu.pdf` (TODO)
- `menu.jpg` (TODO)

Storage URL: `https://storage.menusready.com/{slug}/{filename}`

### 5. Internal Alert Email (Tim + Remi Only)
**Recipients:** Tim + Remi (hardcoded)

**Subject:** "üí∞ New purchase ‚Äî [Restaurant Name]"

**Content:**
- Restaurant name
- Customer email
- Slug
- Timestamp
- "Preview page is now unlocked. Files are live."
- Link to unlocked preview page

**No customer email sent.** Everything downloads from the page.

### 6. Preview Page Transforms to Delivery Page

**Preview page checks Supabase on load:**
```js
const { paid } = await supabase
  .from('restaurants')
  .select('paid')
  .eq('slug', slug)
  .single()
```

**If `paid = false`:** Show normal preview (watermark, timer, CTA)

**If `paid = true`:** Show unlocked delivery page:

#### Unlocked State Features:
‚úÖ **Green success banner** - "Your menu is live ‚Äî [Restaurant Name]"

‚úÖ **Download buttons (2x2 grid):**
- Download PDF
- Download QR Code
- Download Image
- Download Text File

‚úÖ **Live menu link with copy button**
```
https://menusready.com/menu/sarinanas-tamale-factory-santa-ana
[Copy Link]
```

‚úÖ **Share row:**
- Copy Link
- Instagram
- Facebook

‚úÖ **Watermark removed completely**

‚úÖ **All prices visible** (no blur, no restrictions)

‚úÖ **No expiry timer**

‚úÖ **No "Publish" CTA**

## Environment Variables Required

```bash
# Email delivery (internal alerts only)
RESEND_API_KEY=re_your_resend_api_key

# Supabase (for paid status + storage)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key

# Stripe webhook
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
```

## Supabase Setup

### 1. Run Migration
```sql
-- Add paid tracking fields
alter table restaurants 
  add column paid boolean default false,
  add column paid_at timestamp,
  add column customer_email text;
```

### 2. Create Storage Bucket
```sql
-- Create 'menus' bucket for file storage
insert into storage.buckets (id, name, public)
values ('menus', 'menus', true);

-- Allow public read access
create policy "Public read access"
on storage.objects for select
using ( bucket_id = 'menus' );

-- Allow service role to upload
create policy "Service role upload"
on storage.objects for insert
with check ( bucket_id = 'menus' );
```

## User Experience

### Customer Journey:
1. Lands on preview page ‚Üí sees watermark + timer + CTA
2. Clicks "Publish My Menu ‚Äî $99 ‚Üí"
3. Completes Stripe checkout
4. **Redirected back to same preview page**
5. Page now shows green banner + download buttons
6. Downloads QR code, text file, etc. directly from page
7. Shares menu link with customers

### No Email Needed:
- Customer gets everything from the unlocked page
- No inbox clutter
- Files always accessible at the same URL
- Can return later to re-download

## TODO / Future Enhancements

- [ ] PDF generation (using Puppeteer or react-pdf)
- [ ] JPG image generation (convert PDF first page)
- [ ] Automated Yelp/Google Business submission API
- [ ] Analytics dashboard (downloads, views, QR scans)
- [ ] Custom domain support (restaurant.menusready.com)
